<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Expense Dashboard</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      body{ font-family: Arial, sans-serif; margin:0; padding:0; }
      .center { display:flex; align-items:center; justify-content:center; height:100vh; }
      .card{ max-width:1100px; margin:20px auto; padding:18px; box-shadow:0 2px 8px rgba(0,0,0,.12); }
      .row{ display:flex; gap:16px; }
      .col{ flex:1 }
      table{ width:100%; border-collapse:collapse; }
      th,td{ border:1px solid #ddd; padding:8px; text-align:left; }
      th{ background:#f4f4f4; }
      .floating { position:fixed; right:24px; bottom:24px; background:#1e88e5; color:white; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.2); }
      .modal{ position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; }
      .modal-content{ background:white; padding:18px; width:720px; max-width:95%; border-radius:8px; }
      .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
      .small{ font-size:12px;color:#666 }
      .headerTop { display:flex; align-items:center; justify-content:space-between; }
      .projectTop { font-weight:700 }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen" class="center">
      <div style="width:320px;padding:22px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);">
        <h3 style="margin-top:0">Enter 4-digit login code</h3>
        <input id="codeInput" maxlength="4" style="width:100%;padding:10px;font-size:18px;" autofocus>
        <div style="margin-top:12px;text-align:right;">
          <button id="loginBtn">Login</button>
        </div>
        <div id="loginMsg" class="small"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none; padding:20px;">
      <div class="card">
        <div class="headerTop">
          <div>
            <h2 style="margin:0">Expense Dashboard</h2>
            <div class="small">Overview by Project and Item type</div>
          </div>
          <div class="projectTop" id="projectTop">All Projects</div>
        </div>

        <div class="row" style="margin-top:18px;">
          <div class="col" id="chart1" style="min-height:300px"></div>
          <div class="col" id="chart2" style="min-height:300px"></div>
        </div>

        <h3 style="margin-top:20px">Entries</h3>
        <div style="max-height:360px; overflow:auto;">
          <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Floating Add Button -->
    <div class="floating" id="addBtn" title="Add">+</div>

    <!-- Modal Form -->
    <div id="modal" style="display:none;" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">Add Expense</h3>
        <div class="form-grid" id="formGrid"></div>
        <div style="margin-top:12px;text-align:right;">
          <button id="cancelBtn">Cancel</button>
          <button id="submitBtn">Submit</button>
        </div>
      </div>
    </div>

    <script>
      google.charts.load('current', {'packages':['corechart']});
      var header = [], rows = [];

      // Login
      document.getElementById('loginBtn').addEventListener('click', function(){
        var code = document.getElementById('codeInput').value.trim();
        if (!code || code.length !== 4) {
          document.getElementById('loginMsg').innerText='Enter a 4-digit code'; return;
        }
        google.script.run.withSuccessHandler(function(ok){
          if (ok) loadDataAndShow();
          else document.getElementById('loginMsg').innerText='Invalid code';
        }).validateCode(code);
      });

      function loadDataAndShow(){
        google.script.run.withSuccessHandler(function(data){
          header = data.header; rows = data.rows;
          renderTable(); renderCharts();
          document.getElementById('loginScreen').style.display='none';
          document.getElementById('dashboard').style.display='block';
        }).getExpenses();
      }

      function renderTable(){
        var thead=document.getElementById('tableHead'), tbody=document.getElementById('tableBody');
        thead.innerHTML=''; tbody.innerHTML='';
        var tr=document.createElement('tr');
        header.forEach(h=>{ var th=document.createElement('th'); th.innerText=h; tr.appendChild(th); });
        thead.appendChild(tr);
        rows.forEach(r=>{
          var tr=document.createElement('tr');
          header.forEach(h=>{
            var td=document.createElement('td'); td.innerText=r[h]||''; tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function aggregateBy(field){
        var map={};
        rows.forEach(r=>{
          var k=r[field]||'Unspecified';
          var amt=Number(r['Amount'])||0;
          map[k]=(map[k]||0)+amt;
        });
        return map;
      }

      function renderCharts(){
        google.charts.setOnLoadCallback(function(){
          drawPie('Project','chart1');
          drawPie('Item type','chart2');
          var projects=[...new Set(rows.map(r=>r['Project']).filter(Boolean))];
          document.getElementById('projectTop').innerText=projects.length?('Projects: '+projects.join(', ')):'All Projects';
        });
      }

      function drawPie(field,id){
        var map=aggregateBy(field);
        var dataArr=[[field,'Amount']];
        Object.keys(map).forEach(k=>dataArr.push([k,map[k]]));
        var data=google.visualization.arrayToDataTable(dataArr);
        var chart=new google.visualization.PieChart(document.getElementById(id));
        chart.draw(data,{pieHole:0.4,chartArea:{width:'90%',height:'80%'},legend:{position:'right'}});
      }

      // Add Expense
      document.getElementById('addBtn').addEventListener('click', openAddModal);
      document.getElementById('cancelBtn').addEventListener('click', ()=>document.getElementById('modal').style.display='none');
      document.getElementById('submitBtn').addEventListener('click', submitForm);

      function openAddModal(){
        var grid=document.getElementById('formGrid'); grid.innerHTML='';
        header.forEach(h=>{
          var div=document.createElement('div');
          var label=document.createElement('label'); label.innerText=h; div.appendChild(label);
          var input=document.createElement('input');
          if(h.toLowerCase()==='date') input.type='date';
          else if(h.toLowerCase()==='amount') input.type='number';
          else input.type='text';
          input.id='field_'+h.replace(/\\s+/g,'_'); input.style.width='100%';
          div.appendChild(input); grid.appendChild(div);
        });
        document.getElementById('modal').style.display='flex';
      }

      function submitForm(){
        var obj={};
        header.forEach(h=>{
          var el=document.getElementById('field_'+h.replace(/\\s+/g,'_'));
          if(el) obj[h]=el.value;
        });
        google.script.run.withSuccessHandler(function(data){
          header=data.header; rows=data.rows;
          renderTable(); renderCharts();
          document.getElementById('modal').style.display='none';
        }).addExpense(obj);
      }
    </script>
  </body>
</html>
